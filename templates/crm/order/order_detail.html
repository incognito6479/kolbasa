{% extends 'crm/base.html' %}
{% load static %}
{% load widget_tweaks custom_tags %}

{% block content %}
    <div class="row page-titles mx-0">
        <div class="col-sm-12 p-md-0">
            <div class="welcome-text">
                <h4>Заказ: # {{ order.id }} Дата: {{ order.created|date:'d.m.Y H:i' }}</h4>
            </div>
        </div>
        <div class="col-sm-12 p-md-0">
            <div class="">
                <h4 class="text-black-50">
                    <strong class="text-black">Контрагент:</strong>
                    <a type="button" class="btn btn-transparent btn-xs p-2" data-toggle="modal"
                       data-target="#counterPartyModal"
                       style="text-decoration: none"><h4>{{ order.counter_party }}</h4></a>
                    | <strong
                        class="text-black">Агент:</strong> {{ order.agent.user.fullname|default:order.agent.user.username }}
                </h4>
                {% if order.status == 'delivered' or order.status == 'completed' %}
                    <h4 class="text-black-50">
                        <strong class="text-black">Дата доставки:</strong>
                    </h4>
                    <h4>{% if order.delivered_at %}{{ order.delivered_at|date:'d.m.Y H:i' }}{% endif %}</h4>
                {% endif %}
            </div>
        </div>
        <div class="col-12">
            <h5>Коментарий:</h5>
            <p>
                {{ order.comment|default:'' }}
            </p>
        </div>
    </div>
    <div class="row page-titles mx-0">
        <div class="col-md-6">
            <div class="">
                <table border="1" class="table table-responsive-md">
                    <tr>
                        <td class="bg-light">Статус</td>
                        <td>{{ order.get_status_display }}</td>
                        <td class="bg-light">Сумма</td>
                        <td>{{ order.total|to_local }} сум</td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="col-md-6">
            <div class="d-flex justify-content-end">
                {% if order.status == 'created' %}
                    <form class="mr-1" method="POST" action="{% url 'order_actions' order.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="change_order_status">
                        <input type="hidden" name="status" value="accepted">
                        <button type="submit" class="btn btn-success">Принять</button>
                    </form>
                    <form method="POST" action="{% url 'order_actions' order.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="change_order_status">
                        <input type="hidden" name="status" value="rejected">
                        <button type="submit" class="btn btn-danger">Отменить</button>
                    </form>
                {% elif order.status == 'accepted' %}
                    <form class="mr-1" method="POST" action="{% url 'order_actions' order.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="change_order_status">
                        <input type="hidden" name="status" value="delivered">
                        <button type="submit" class="btn btn-primary">Доставлено</button>
                    </form>
                    <form method="POST" action="{% url 'order_actions' order.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="change_order_status">
                        <input type="hidden" name="status" value="rejected">
                        <button type="submit" class="btn btn-danger">Отменить</button>
                    </form>
                {% elif order.status == 'delivered' %}
                    <form class="mr-1" method="POST" action="{% url 'order_actions' order.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="change_order_status">
                        <input type="hidden" name="status" value="completed">
                        <button type="submit" class="btn btn-secondary">Завершить</button>
                    </form>
                    <form method="POST" action="{% url 'order_actions' order.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="change_order_status">
                        <input type="hidden" name="status" value="rejected">
                        <button type="submit" class="btn btn-danger">Отменить</button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Элементы заказов</h4>
                </div>
                <div class="card-body">
                    <table class="table table-responsive-md">
                        <thead>
                        <tr>
                            {% setvar 0 as total_count_p %}
                            {% setvar 0 as total_count_kg %}
                            <th class="text-center"><strong>#<br><span style="font-size: 8px">&nbsp;</span></strong>
                            </th>
                            <th class="text-center"><strong>Товар<br><span style="font-size: 8px">&nbsp;</span></strong>
                            </th>
                            <th class="text-center"><strong>Количество<br><span
                                    style="font-size: 8px">&nbsp;</span></strong></th>
                            <th class="text-center"><strong>Цена<br><span
                                    style="font-size: 8px">(За ед.)</span></strong></th>
                            <th class="text-center"><strong>Сумма<br><span
                                    style="font-size: 8px">(Общая)</span></strong></th>
                            <th class="text-center"><strong>&nbsp;<br><span
                                    style="font-size: 8px">&nbsp;</span></strong></th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for item in order_items %}
                            <tr>
                                {% if item.warehouse_product.product.unit_type == 'piece' %}
                                    {% setvar total_count_p|plus:item.count as total_count_p %}
                                {% else %}
                                    {% setvar total_count_kg|plus:item.count as total_count_kg %}
                                {% endif %}
                                <td class="text-center"><strong>{{ item.id }}</strong></td>
                                <td class="text-center">{{ item.warehouse_product }}</td>
                                <td class="text-center">{{ item.count }} {{ item.warehouse_product.product.get_unit_type_display }}</td>
                                <td class="text-center">{{ item.price|to_local }} сум</td>
                                <td class="text-center">{{ item.total|to_local }} сум</td>
                                <td class="text-center">
                                    {% if order.status == 'created' %}
                                        <div class="d-flex justify-content-center">
                                            <form method="POST" action="{% url 'order_actions' order.id %}">
                                                {% csrf_token %}
                                                <input type="hidden" name="warehouse_product_id" value="{{ item.id }}">
                                                <input type="hidden" name="action" value="delete_order_item">
                                                <button title="Удаление" type="submit"
                                                        class="btn btn-danger shadow btn-xs sharp"><i
                                                        class="fa fa-trash"></i></button>
                                            </form>
                                        </div>
                                    {% endif %}
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">Пусто</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                        <tfoot>
                        <tr>
                            <td class="text-center"></td>
                            <td class="text-center">Итог:</td>
                            <td class="text-center" id="total_count">{{ order_items_totals.total_count_kg|default:0 }} кг/{{ order_items_totals.total_count_p|default:0 }} шт
                            </td>
                            <td class="text-center"></td>
                            <td class="text-center">{{ order_items_totals.total|default:0|to_local }} сум</td>
                            <td class="text-center"></td>
                        </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        {% if order.status == 'created' %}
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Добавить Товар</h4>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{% url 'order_actions' order.id %}">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-3">
                                    <label>Категория Товар</label>
                                    <select name="warehouse" class="form-control product_category_select" required>
                                        <option value="" selected disabled>----</option>
                                        {% for i in product_categories %}
                                            <option value="{{ i.id }}">{{ i.title }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label>Склад Товары</label>
                                    <select id="warehouse_product_id" name="warehouse_product_id"
                                            class="form-control product_select" required>
                                        <option value="" selected>----</option>
                                        {% for i in warehouse_products %}
                                            <option class="products product_category_{{ i.product.category_id }}"
                                                    value="{{ i.id }}" data-price="{{ i.product.show_price }}">
                                                {{ i.product }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label>Количество</label>
                                    <input name="count" type="number" min="0" class="form-control" required>
                                </div>
                                <div class="col-md-3">
                                    <label>Цена</label>
                                    <input name="price" type="number" min="0" class="form-control" required>
                                </div>
                                <div class="col-md-2 mt-5">
                                    <input type="hidden" name="action" value="add_order_item">
                                    <button type="submit" class="btn btn-primary">Добавить</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        {% elif order.status == 'accepted' %}
            <div class="col-lg-12">
                <div class="card">
                    <form method="POST" action="{% url 'order_actions' order.id %}">
                        <div class="card-header row">
                            <div class="col-12 row align-items-between mx-0 px-0">
                                <div class="col">
                                    <h4 class="card-title">Накладная №{{ invoice.id }}</h4>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-sm btn-success" onclick="print_invoice({{ invoice.id }})"
                                            type="button">Печатать
                                    </button>
                                    <a href="{% url 'invoice_excel_download' invoice.id %}" class="btn btn-sm btn-info">Сохранить
                                        как Excel</a>
                                </div>
                            </div>
                            {% csrf_token %}
                            <div class="col-4 mt-3">
                                <label for="invoice_provider_id">Поставщик:</label>
                                <select class="form-control" name="invoice_provider">
                                    <option value="" disabled>---</option>
                                    {% for invoice_provider in invoice_providers %}
                                        <option value="{{ invoice_provider.id }}"
                                                {% if invoice_provider.id == invoice.invoice_provider_id %}
                                                selected
                                                {% endif %}>
                                            {{ invoice_provider.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-4 mt-3">
                                <label for="invoice_discount_id">Скидка:</label>
                                <input name="invoice_discount" id="invoice_discount_id" type="number" step="any"
                                       required class="form-control" value="{{ invoice.discount }}">
                            </div>
                            <div class="col-4 mt-3">
                                <label for="invoice_deliver_id">Доставщик:</label>
                                <select class="form-control" name="invoice_deliver">
                                    <option value {% if not invoice.deliver %}selected{% endif %}>---</option>
                                    {% for invoice_deliver in invoice_delivers %}
                                        <option value="{{ invoice_deliver.id }}"
                                                {% if invoice_deliver.id == invoice.deliver.id %}
                                                selected
                                                {% endif %}>
                                            {{ invoice_deliver.user.username }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <input type="hidden" name="action" value="change_invoice_item_counts">
                            {% setvar 0 as total_count_p %}
                            {% setvar 0 as total_count_kg %}
                            <table class="table table-responsive-md">
                                <thead>
                                <tr>
                                    <th><strong>#</strong></th>
                                    <th><strong>Наименования товаров</strong></th>
                                    <th><strong>Кол-во</strong></th>
                                    <th><strong>Ед. изм.</strong></th>
                                    <th><strong>Цена</strong></th>
                                    <th><strong>Сумма</strong></th>
                                    {% if order.status == 'created' %}
                                        <th><strong>Действие</strong></th>
                                    {% endif %}
                                </tr>
                                </thead>
                                <tbody>
                                {% for item in invoice_items %}
                                    <tr>
                                        {% if item.order_item.warehouse_product.product.unit_type == 'piece' %}
                                            {% setvar total_count_p|plus:item.count as total_count_p %}
                                        {% else %}
                                            {% setvar total_count_kg|plus:item.count as total_count_kg %}
                                        {% endif %}
                                        <td><strong>{{ forloop.counter }}</strong></td>
                                        <td>{{ item.order_item.warehouse_product.product.title }}</td>
                                        <td><input class="form-control invoice_item_count" onchange="calcCount()"
                                                   data-unit-type="{{ item.order_item.warehouse_product.product.unit_type }}"
                                                   name="invoice_item_{{ item.id }}_count"
                                                   type="number" step="any" value="{{ item.count|fix_float }}"></td>
                                        <td>{{ item.order_item.warehouse_product.product.get_unit_type_display }}</td>
                                        <td>{{ item.order_item.price|to_local }} сум</td>
                                        <td>{% if item.item_type == 'bonus' and not item.total > 0 %}Бонус
                                            {% else %}{{ item.total|to_local }} сум{% endif %}</td>
                                        {% if order.status == 'created' %}
                                            <td>
                                                <div class="d-flex">
                                                    <form method="POST" action="{% url 'order_actions' order.id %}">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="warehouse_product_id"
                                                               value="{{ item.id }}">
                                                        <input type="hidden" name="action" value="delete_order_item">
                                                        <button type="submit"
                                                                class="btn btn-danger shadow btn-xs sharp"><i
                                                                class="fa fa-trash"></i></button>
                                                    </form>
                                                </div>
                                            </td>
                                        {% endif %}
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="9" class="text-center">Пусто</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                                <tfoot>
                                <tr>
                                    <td></td>
                                    <td>Итог:</td>
                                    <td id="total_count"></td>
                                    <td></td>
                                    <td>{{ invoice.total_without_discount|to_local }}</td>
                                    <td>{{ invoice.total|to_local }}</td>
                                </tr>
                                </tfoot>
                            </table>
                            <div class="col-12 d-flex justify-content-end">
                                <button class="btn btn-primary" type="submit">Сохранить</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            </div>
        {% elif order.status == 'delivered' %}

            <div class="col-lg-12">
                <div class="card">
                    <form method="POST" action="{% url 'order_actions' order.id %}">
                        {% csrf_token %}
                        <div class="card-header row">
                            <div class="col-12 row align-items-between mx-0 px-0">
                                <div class="col">
                                    <h4 class="card-title">Список возвратов</h4>
                                </div>
                                <div class="col-auto">
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <input type="hidden" name="action" value="return_items_acceptance">
                            <table class="table table-responsive-md">
                                <thead>
                                <tr>
                                    {% setvar 0 as total_count_p %}
                                    {% setvar 0 as total_count_kg %}
                                    <th><strong>#</strong></th>
                                    <th><strong>Наименования товаров</strong></th>
                                    <th><strong>Кол-во</strong></th>
                                    <th><strong>Ед. изм.</strong></th>
                                    <th><strong>Цена</strong></th>
                                    <th><strong>Сумма</strong></th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for item in return_items %}
                                    <tr>
                                        {% if item.warehouse_product.product.unit_type == 'piece' %}
                                            {% setvar total_count_p|plus:item.count as total_count_p %}
                                        {% else %}
                                            {% setvar total_count_kg|plus:item.count as total_count_kg %}
                                        {% endif %}
                                        <td><input type="checkbox" name="return_item_{{ item.id }}"></td>
                                        <td>{{ item.warehouse_product.product.title }}</td>
                                        <td><input class="form-control return_item_count"
                                                   onchange="calcReturnItem(this)"
                                                   data-id="{{ item.id }}"
                                                   data-unit-type="{{ item.warehouse_product.product.unit_type }}"
                                                   name="return_item_{{ item.id }}_count"
                                                   type="number" step="any" value="{{ item.count|floatformat }}"></td>
                                        <td>{{ item.warehouse_product.product.get_unit_type_display }}</td>
                                        <td><input class="form-control return_item_price"
                                                   onchange="calcReturnItem(this)"
                                                   data-id="{{ item.id }}"
                                                   data-unit-type="{{ item.warehouse_product.product.unit_type }}"
                                                   name="return_item_{{ item.id }}_price"
                                                   type="number" step="1" value="{{ item.price }}"></td>
                                        <td><input class="form-control return_item_total"
                                                   onchange="calcReturnItem(this)"
                                                   data-id="{{ item.id }}" readonly
                                                   data-unit-type="{{ item.warehouse_product.product.unit_type }}"
                                                   name="return_item_{{ item.id }}_total"
                                                   type="number" step="1" value="{{ item.total }}"></td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center">Пусто</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                                <tfoot>
                                <tr>
                                    <td></td>
                                    <td>Итог:</td>
                                    <td id="total_count"></td>
                                    <td></td>
                                    <td></td>
                                    <td id="total">{{ return_items_total }}</td>
                                </tr>
                                </tfoot>
                            </table>
                            <div class="col-12 d-flex justify-content-end">
                                <button class="btn btn-primary" type="submit">Принять</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            </div>
        {% elif order.status == 'completed' %}
            <div class="col-lg-12">
                <div class="card">
                    <div>
                        <div class="card-header row">
                            <div class="col-12 row align-items-between mx-0 px-0">
                                <div class="col">
                                    <h4 class="card-title"><a href="{{ invoice.photo.url }}">Накладной №{{ invoice.id }}</a>
                                        | {% if invoice.deliver %}{{ invoice.deliver.user.fullname|default:invoice.deliver.user.username }}{% endif %}</h4>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-sm btn-success" onclick="print_invoice({{ invoice.id }})"
                                            type="button">Печатать
                                    </button>
                                    <a href="{% url 'invoice_excel_download' invoice.id %}" class="btn btn-sm btn-info">Сохранить
                                        как Excel</a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <table class="table table-responsive-md">
                                <thead>
                                <tr>
                                    <th><strong>#</strong></th>
                                    <th><strong>Наименования товаров</strong></th>
                                    <th><strong>Кол-во</strong></th>
                                    <th><strong>Ед. изм.</strong></th>
                                    <th><strong>Цена</strong></th>
                                    <th><strong>Цена со скидкой</strong></th>
                                    <th><strong>Сумма</strong></th>
                                    <th><strong>Сумма со скидкой</strong></th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for item in invoice_items %}
                                    <tr>
                                        <td><strong>{{ forloop.counter }}</strong></td>
                                        <td>{{ item.order_item.warehouse_product.product.title }}</td>
                                        <td>{{ item.count }}</td>
                                        <td>{{ item.order_item.warehouse_product.product.get_unit_type_display }}</td>
                                        <td>{{ item.order_item.warehouse_product.product.price|to_local }} сум</td>
                                        <td>{{ item.order_item.warehouse_product.product.show_price|to_local }} сум</td>
                                        <td>{{ item.count|mul:item.order_item.warehouse_product.product.price|to_local }}
                                            сум
                                        </td>
                                        <td>{{ item.total|to_local }} сум</td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="9" class="text-center">Пусто</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                                <tfoot>
                                <tr>
                                    <td></td>
                                    <td>Итог:</td>
                                    <td id="total_count"></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>{{ invoice.total_without_discount|to_local }}</td>
                                    <td>{{ invoice.total|to_local }}</td>
                                </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>


    <!-- Modal -->
    <div class="modal fade" id="counterPartyModal" tabindex="-1"
         aria-labelledby="counterPartyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"
                        id="counterPartyModal">{{ order.counter_party.full_name }}</h5>
                    <button type="button" class="close" data-dismiss="modal"
                            aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-header d-inline">
                    <table class="table table-striped table-bordered">
                        <tr>
                            <th>Номер телефона:</th>
                            <td>{{ order.counter_party.phone_number }}</td>
                        </tr>
                        <tr>
                            <th>Адрес контрагента:</th>
                            <td>{{ order.counter_party.address|default:'-' }}</td>
                        </tr>
                        <tr>
                            <th>Комментарии о контрагента:</th>
                            <td>{{ order.counter_party.content|default:'-' }}</td>
                        </tr>
                        <tr>
                            <th>Оринтир:</th>
                            <td>{{ order.counter_party.landmark|default:'-' }}</td>
                        </tr>
                        <tr>
                            <th>Баланс:</th>
                            <td>{{ order.counter_party.balance }}</td>
                        </tr>
                    </table>
                </div>
                <div class="modal-body">
                    <div id="map" style="width: 100%; height: 250px"></div>
                </div>
            </div>
        </div>
    </div>

{% endblock content %}

{% block extra_js %}
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&amp;apikey=<ваш API-ключ>" type="text/javascript"></script>
    <script src="icon_customImage.js" type="text/javascript"></script>
    <script>
        ymaps.ready(function () {
            var myMap = new ymaps.Map('map', {
                    center: '{{ order.counter_party.marker }}'.split(','),
                    zoom: 15
                }, {
                    searchControlProvider: 'yandex#search'
                }),

                // Создаём макет содержимого.
                MyIconContentLayout = ymaps.templateLayoutFactory.createClass(
                    '<div style="color: #FFFFFF; font-weight: bold;">$[properties.iconContent]</div>'
                ),

                myPlacemarkWithContent = new ymaps.Placemark('{{ order.counter_party.marker }}'.split(','), {
                    hintContent: '{{ order.counter_party.full_name }}',
                    balloonContent: '{{ order.counter_party.landmark }}',
                }, {
                    // Опции.
                    // Необходимо указать данный тип макета.
                    iconLayout: 'default#imageWithContent',
                    // Своё изображение иконки метки.
                    iconImageHref: '{% static 'crm/images/map-marker-icon.png' %}',
                    // Размеры метки.
                    iconImageSize: [20, 20],
                    // Смещение левого верхнего угла иконки относительно
                    // её "ножки" (точки привязки).
                    iconImageOffset: [-10, -10],
                    // Макет содержимого.
                    iconContentLayout: MyIconContentLayout
                });

            myMap.geoObjects
                .add(myPlacemarkWithContent);
        });

        function calcReturnItem(elem = undefined) {
            let return_items_count_tags = document.querySelectorAll('.return_item_count');
            let total_count_kg = 0;
            let total_count_p = 0;
            for (let item of return_items_count_tags) {
                if (item.getAttribute('data-unit-type') === 'kg') {
                    total_count_kg += +item.value
                } else {
                    total_count_p += +item.value
                }
            }

            if (elem) {
                let return_item_id = +elem.getAttribute('data-id');
                document.querySelector(`input[name=return_item_${return_item_id}_total]`).value =
                    +document.querySelector(`input[name=return_item_${return_item_id}_count]`).value *
                    +document.querySelector(`input[name=return_item_${return_item_id}_price]`).value;
            }

            let total = 0;
            let invoice_items_total_tags = document.querySelectorAll('.return_item_total');
            for (let item_total of invoice_items_total_tags) {
                total += +item_total.value
            }
            console.log(total.toLocaleString());
            document.getElementById('total_count').textContent = `${total_count_kg} кг/${total_count_p} шт`;
            document.getElementById('total').textContent = `${total.toLocaleString()} сум`;
        }

        function calcCount() {
            let invoice_items_count_tags = document.querySelectorAll('.invoice_item_count');
            let total_count_kg = 0;
            let total_count_p = 0;
            for (let item of invoice_items_count_tags) {
                if (item.getAttribute('data-unit-type') === 'kg') {
                    total_count_kg += +item.value
                } else {
                    total_count_p += +item.value
                }
            }
            console.log(total_count_kg, total_count_p, document.getElementById('total_count'));
            document.getElementById('total_count').innerText = `${total_count_kg} кг/${total_count_p} шт`
        }

        $(document).ready(() => {
            {% if order.status == 'accepted' %}
                calcCount();
            {% elif order.status == 'delivered' %}
                calcReturnItem();
            {% endif %}
        });
        $('.product_category_select').on('change', function () {
            let id = this.value;
            $('.dropdown-toggle').click();
            $('.products').addClass('d-none');
            $('#warehouse_product_id').val('').change();
            setTimeout(function () {
                $('.product_category_' + id).removeClass('d-none')
            }, 500)
        });

        async function print_invoice(id) {
            let print_url = "{% url 'order_invoice_print_ajax' %}";
            let total1 = 0;
            let total2 = 0;
            let total3 = 0;
            let total_count_p1 = 0;
            let total_count_kg1 = 0;
            let total_count_p2 = 0;
            let total_count_kg2 = 0;
            let total_count_p3 = 0;
            let total_count_kg3 = 0;

            let header = ``;
            let body1 = ``;
            let body2 = ``;
            let body3 = ``;
            let template = ``;
            await fetch(print_url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({'id': id}),
            }).then(response => response.json())
                .then(data => {
                    // console.log(data['data_0'][0]['invoice_provider__address'])
                    let print_logo = data['data_0'][0]['invoice_provider__logo'];
                    header += `
                    <div>
                        <div class="text-center mb-4">
                            <h2>Товарная накладная №: ${data['data_0'][0]['id']} Дата: ${data['data_0'][0]['created'].split("T")[0]}</h2>
                        </div>
                        <div class="row">
                            <div class="col-7">
                                <h3>Поставщик: ${data['data_0'][0]['invoice_provider__name']}</h3>
                                <h3>Адрес: ${data['data_0'][0]['invoice_provider__address']}</h3>
                                <h3>Телефон: ${data['data_0'][0]['invoice_provider__phone_number']}</h3>

                                <div style="width: 200px; height: 70px;">
                                    <img src="./media/${print_logo}" alt="invoice_provider_logo">
                                </div>
                            </div>
                            <div class="col-5">
                                <h3><b>Получатель: ${data['data_0'][0]['order__counter_party__full_name']}</b></h3>
                                <h3>Адрес: ${data['data_0'][0]['order__counter_party__address']}</h3>
                                <h3>Телефон: ${data['data_0'][0]['order__counter_party__phone_number']}</h3>

                                <button class="px-5" style="background-color: #eee;">
                                    <h2>
                                        <b><u>
                                            Долг: ${data['data_0'][0]['order__counter_party__balance'].toLocaleString()}
                                        </b></u>
                                    </h2>
                                </button>
                            </div>
                        </div>
                    </div>`;
                    let header1 = `
                    <table border="1" class="table">
                        <thead>
                            <tr style="background-color: #eee;">
                                <th>№</th>
                                <th>Наименования товаров</th>
                                <th>Кол-во</th>
                                <th>Ед. изм.</th>
                                <th>Цена</th>
                                <th>Сумма</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                    for (let i = 0; i < data['data_1'].length; i++) {
                        // console.log(data['data_1'][i])

                        total1 += data['data_1'][i]['total']
                        if (data['data_1'][i]['order_item__warehouse_product__product__unit_type'] === 'piece') {
                            total_count_p1 += data['data_1'][i]['count']
                            data['data_1'][i]['order_item__warehouse_product__product__unit_type'] = 'Шт'
                        } else {
                            total_count_kg1 += data['data_1'][i]['count']
                            data['data_1'][i]['order_item__warehouse_product__product__unit_type'] = 'Кг'
                        }
                        let forloop_counter = 1;
                        if (i != 0) {
                            forloop_counter = i;
                        }
                        body1 += `
                        <tr>
                            <td>${forloop_counter}</td>
                            <td>${data['data_1'][i]['order_item__warehouse_product__product__title']}</td>
                            <td class="text-center">${data['data_1'][i]['count']}</td>
                            <td>${data['data_1'][i]['order_item__warehouse_product__product__unit_type']}</td>
                            <td>${data['data_1'][i]['order_item__price'].toLocaleString()}</td>
                            <td class="text-center">${data['data_1'][i]['total'].toLocaleString()}</td>
                        </tr>
                    `
                    }
                    let footer1 = `
                    <tr>
                        <td></td>
                        <td class="text-center"><h4><b>Итого:</b></h4></td>
                        <td class="text-center"><h4><b>${total_count_kg1} кг/ ${total_count_p1} шт</b></h4></td>
                        <td></td>
                        <td></td>
                        <td class="text-center" style="background-color: #eee;"><h4><b>${total1.toLocaleString()}</b></h4></td>
                    </tr>
                    </tbody>
                </table>`
                    let header2 = `
                    <table border="1" class="table">
                        <tbody>
                `
                    for (let i = 0; i < data['data_2'].length; i++) {
                        // console.log(data['data_2'][i])

                        total2 += data['data_2'][i]['total']
                        if (data['data_2'][i]['order_item__warehouse_product__product__unit_type'] === 'piece') {
                            total_count_p2 += data['data_2'][i]['count']
                            data['data_2'][i]['order_item__warehouse_product__product__unit_type'] = 'Шт'
                        } else {
                            total_count_kg2 += data['data_2'][i]['count']
                            data['data_2'][i]['order_item__warehouse_product__product__unit_type'] = 'Кг'
                        }
                        let forloop_counter = 1;
                        if (i != 0) {
                            forloop_counter = i;
                        }
                        body2 += `
                        <tr>
                            <td>${forloop_counter}</td>
                            <td>${data['data_2'][i]['order_item__warehouse_product__product__title']}</td>
                            <td class="text-center">${data['data_2'][i]['count']}</td>
                            <td>${data['data_2'][i]['order_item__warehouse_product__product__unit_type']}</td>
                            <td>${data['data_2'][i]['order_item__price'].toLocaleString()}</td>
                            <td class="text-center">${data['data_2'][i]['total'] > 0 ? data['data_2'][i]['total'].toLocaleString() : 'Бонус'}</td>
                        </tr>
                    `
                    }
                    let footer2 = `
                    <tr>
                        <td></td>
                        <td class="text-center"><h4><b>Итого:</b></h4></td>
                        <td class="text-center"><h4><b>${total_count_kg2} кг/ ${total_count_p2} шт</b></h4></td>
                        <td></td>
                        <td></td>
                        <td class="text-center" style="background-color: #eee;"><h4><b>${total2.toLocaleString()}</b></h4></td>
                    </tr>
                    </tbody>
                </table>`
                    let header3 = `
                    <table border="1" class="table">
                        <tbody>
                `
                    for (let i = 0; i < data['data_3'].length; i++) {
                        // console.log(data['data_3'][i])

                        total3 += data['data_3'][i]['total']
                        if (data['data_3'][i]['order_item__warehouse_product__product__unit_type'] === 'piece') {
                            total_count_p3 += data['data_3'][i]['count']
                            data['data_3'][i]['order_item__warehouse_product__product__unit_type'] = 'Шт'
                        } else {
                            total_count_kg3 += data['data_3'][i]['count']
                            data['data_3'][i]['order_item__warehouse_product__product__unit_type'] = 'Кг'
                        }
                        let forloop_counter = 1;
                        if (i != 0) {
                            forloop_counter = i;
                        }
                        body3 += `
                        <tr>
                            <td>${forloop_counter}</td>
                            <td>${data['data_3'][i]['order_item__warehouse_product__product__title']}</td>
                            <td class="text-center">${data['data_3'][i]['count']}</td>
                            <td>${data['data_3'][i]['order_item__warehouse_product__product__unit_type']}</td>
                            <td>${data['data_3'][i]['order_item__price'].toLocaleString()}</td>
                            <td class="text-center">${data['data_3'][i]['total_without_discount'].toLocaleString()}</td>
                        </tr>
                    `
                    }
                    let footer3 = `
                    <tr>
                        <td></td>
                        <td class="text-center"><h4><b>Итого:</b></h4></td>
                        <td class="text-center"><h4><b>${total_count_kg3} кг/ ${total_count_p3} шт</b></h4></td>
                        <td></td>
                        <td></td>
                        <td class="text-center" style="background-color: #eee;"><h4><b>${total3.toLocaleString()} (${data['data_0'][0]['discount']}%)</b></h4></td>
                    </tr>
                    </tbody>
                </table>`

                    let footer_end = `
                <div class="row mt-5">
                    <div class="col-6">
                        <b>
                            Долг______________________________
                        </b>
                    </div>
                    <div class="col-6">
                        <b>
                            Расчеть_______________________________
                        </b>
                    </div>
                    <div class="col-12">
                        <table border="1" class="table">
                            <tr>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                        </table>
                    </div>
                </div>
            `
                    template = header + header1 + body1 + footer1 + header2 + body2 + footer2 + header3 + body3 + footer3 + footer_end;
                });
            document.body.innerHTML = template;
            window.print();
            window.location.reload();
        }
    </script>
{% endblock %}